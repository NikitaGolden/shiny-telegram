const express = require('express');
const cors = require('cors');
const fs = require('fs');
const path = require('path');
const app = express();

app.use(cors());
app.use(express.json());
app.use(express.static('.'));

let db = {
    users: {},
    numbers: [],
    payments: []
};

// Load DB
function loadDB() {
    try {
        const data = fs.readFileSync('db.json');
        db = JSON.parse(data);
    } catch(e) {}
}

// Save DB
function saveDB() {
    fs.writeFileSync('db.json', JSON.stringify(db, null, 2));
}

loadDB();

// Auth
app.post('/api/auth', (req, res) => {
    const {username, password} = req.body;
    if(!db.users[username] || db.users[username].password !== password) {
        db.users[username] = {id: Date.now(), password, balance: 0};
        saveDB();
    }
    res.json({success: true, user: db.users[username]});
});

// Verify Payment (mock - in real check blockchain)
app.post('/api/verify-payment', (req, res) => {
    const {userId, txHash, country, service} = req.body;
    
    // Mock confirmation (60s delay simulation)
    setTimeout(() => {
        const phone = generatePhone(country);
        const number = {id: Date.now(), phone, userId, service, sms: [], expires: Date.now() + 10*60*1000};
        db.numbers.push(number);
        saveDB();
        
        res.json({success: true, number});
    }, 3000);
});

// SMS Refresh
app.post('/api/sms-refresh', (req, res) => {
    const {phone} = req.body;
    const number = db.numbers.find(n => n.phone === phone);
    if(number && number.expires > Date.now()) {
        number.sms.push(`Code: ${Math.floor(100000 + Math.random()*900000)}`);
        saveDB();
        res.json({sms: number.sms.slice(-3)});
    } else {
        res.json({sms: []});
    }
});

// Generate fake phone
function generatePhone(country) {
    if(country === 'us' || country === 'ca') {
        return `+1-${Math.floor(1000000000 + Math.random()*900000000)}`;
    } else {
        return `+44-${Math.floor(7000000000 + Math.random()*3000000000)}`;
    }
}

app.listen(3000, () => console.log('ğŸš€ Server running on port 3000'));
